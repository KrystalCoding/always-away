{% extends 'base.html' %}
{% block content %}
{% load crispy_forms_tags %}
{% load cloudinary %}

<div class="container">
    <h1>Photo Gallery</h1>
    <div class="row">
        {% for photo in photos %}
        <div class="col-md-4">
            <div class="card photo-container" data-photo-id="{{ photo.id }}">
                <img src="{{ photo.image.url }}" class="card-img-top" alt="{{ photo.caption }}">
                <div class="card-body">
                    <h5 class="card-title">{{ photo.caption }}</h5>
                    <strong>
                        {% if user.is_authenticated %}
                        <form class="d-inline" action="{% url 'photo_like' photo.id %}" method="POST">
                            {% csrf_token %}
                            {% if photo_liked %}
                            <button type="submit" name="photo_id" value="{{ photo.id }}" class="btn-like">
                                <i class="fas fa-heart"></i>
                            </button>
                            {% else %}
                            <button type="submit" name="photo_id" value="{{ photo.id }}" class="btn-like">
                                <i class="far fa-heart"></i>
                            </button>
                            {% endif %}
                        </form>
                        {% else %}
                        <span class="text-secondary"><i class="far fa-heart"></i></span>
                        {% endif %}
                        <span class="text-secondary">{{ photo.number_of_likes }}</span>
                    </strong>
                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const photoContainers = document.querySelectorAll('.photo-container');

                        photoContainers.forEach(container => {
                            container.addEventListener('click', function () {
                                const photoId = this.dataset.photoId;
                                window.location.href = `/photo/${photoId}/`; // Redirect to photo detail page
                            });
                        });
                    });
                </script>
                <div class="card-footer">
                    <h6>Comments:</h6>
                    {% for comment in photo.comments.all %}
                        {% if comment.approved and comment.created_on %}
                        <div class="comments">
                            <p class="font-weight-bold">
                                {{ comment.name }}
                                <span class="text-muted font-weight-normal">
                                    {{ comment.created_on }}
                                </span> wrote:
                            </p>
                            {{ comment.body | linebreaks }}
                        </div>
                        {% if user.is_authenticated and user.username == comment.name %}
                        <div class="comment-actions">
                            <a href="{% url 'edit_photo_comment' photo.id comment.id %}" class="btn btn-sm btn-primary">Edit</a>
                            <a href="{% url 'delete_photo_comment' photo.id comment.id %}" class="btn btn-sm btn-danger">Delete</a>
                        </div>
                        {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'add_photo_comment' photo.id %}">
                        {% csrf_token %}
                        {{ comment_form | crispy }}
                        <button type="submit" class="btn btn-success mt-3">Submit Comment</button>
                    </form>
                    {% endif %}
                </div>
                                
            </div>
        </div>
        {% endfor %}
    </div>
    <a href="{% url 'upload_photo' %}" class="btn btn-success mt-3">Upload New Photo</a>
</div>


{% endblock %}